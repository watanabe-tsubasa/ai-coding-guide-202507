# 開発進捗サマリー

## 1. テスト環境の構築

- **テストフレームワークの導入**: `vitest` と `jsdom` をプロジェクトに追加し、Reactコンポーネントとフックのテストを行えるように設定しました。
- **設定ファイルの更新**: `package.json` に `test` スクリプトを追加し、`vite.config.ts` に `vitest` の設定（`globals`, `environment`）を追記しました。

## 2. コアロジックのTDDによる実装

テスト駆動開発（TDD）のアプローチに従い、以下のコアモジュールを実装しました。

### `utils` ディレクトリ
- `physics.ts`: ベクトル演算（加算、減算）、距離計算、正規化など、ゲームの物理計算の基礎となる関数を実装しました。
- `spawner.ts`: プレイヤーの周囲（画面外）に敵を生成するためのランダムな座標を計算する関数を実装しました。

### `hooks` ディレクトリ
- `useKeyboard.ts`: `keydown` および `keyup` イベントを監視し、現在押されているキーのセットを返すカスタムフックを実装しました。
- `useGameLoop.ts`: `requestAnimationFrame` をベースにしたゲームループを管理するカスタムフックを実装しました。フレーム間の経過時間（デルタタイム）を計算し、コールバック関数に渡す機能も含まれています。

## 3. 基本的なゲーム画面の実装

- **コンポーネントの作成**: 
  - `Player.tsx`: プレイヤーキャラクター（現在は青い円）を描画するSVGコンポーネントを作成しました。
  - `Game.tsx`: ゲーム全体のメインコンポーネント。以下の役割を担います。
    - ゲーム状態（`GameState`）の管理。
    - `useGameLoop` と `useKeyboard` フックを組み合わせて、プレイヤーの移動ロジックを実装。
    - プレイヤーを追従するカメラ（SVGの`viewBox`）を実装。
- **エントリーポイントの更新**: `App.tsx` を修正し、作成した `Game` コンポーネントを呼び出すように変更しました。

## 4. ゲームメカニクスの実装

- **敵キャラクター**:
  - `Enemy.tsx` コンポーネントを作成し、敵を赤い円として描画。
  - `Game.tsx` 内で、プレイヤーを追跡する移動ロジックを実装。
  - `spawner.ts` を利用し、5秒ごとに新しい敵をプレイヤーの周囲に生成するロジックを実装。
- **弾丸システム**:
  - `Bullet.tsx` コンポーネントを作成し、弾を黄色い円として描画。
  - `Game.tsx` 内で、1秒ごとに最も近い敵を自動的に狙って弾を発射するロジックを実装。
- **衝突判定**:
  - **弾と敵**: 弾が敵に当たると、弾は消滅し、敵のHPが減少。HPが0になると敵も消滅。
  - **プレイヤーと敵**: 敵がプレイヤーに接触すると、プレイヤーのHPが減少。

## 5. 経験値とレベルアップシステムの実装

- **経験値オーブ**:
  - `Experience.tsx` コンポーネントを作成し、オーブを緑色の円として描画。
  - 敵が倒されると、その位置に経験値オーブが生成されるように実装。
- **経験値の獲得とレベルアップ**:
  - プレイヤーがオーブに触れると、オーブが消滅し、プレイヤーの経験値が増加。
  - 経験値が閾値（`レベル * 100`）に達すると、プレイヤーのレベルが上がり、経験値がリセットされるロジックを実装。

## 6. UIの実装

- **ステータス表示**:
  - `GameUI.tsx` コンポーネントを作成し、プレイヤーのHP、レベル、経験値を画面左上に表示。
  - HPと経験値は、視覚的に分かりやすいプログレスバー形式で実装。

## 7. ゲームオーバー処理の実装

- **ゲームオーバー判定**:
  - プレイヤーのHPが0以下になった場合にゲームオーバーと判定するロジックを実装。
- **ゲームの停止と再開**:
  - ゲームオーバー時にゲームループを停止。
  - `GameOverScreen.tsx` コンポーネントを作成し、リスタートボタンを持つゲームオーバー画面を表示。
  - リスタートボタンを押すと、ゲームの状態が初期化され、再開できるように実装。

## 8. レベルアップ時のアップグレード選択機能の実装

- **アップグレードシステムの導入**:
  - `Upgrade` 型を `src/types/game.ts` に定義し、プレイヤーのステータス（速度、連射速度、弾速、弾の威力）を強化できるようにしました。
  - `src/utils/upgrades.ts` に具体的なアップグレードの選択肢を定義しました。
- **UIの実装**:
  - `UpgradeScreen.tsx` コンポーネントを作成し、レベルアップ時に3つのランダムなアップグレード選択肢を提示するようにしました。
- **ゲームフローの更新**:
  - レベルアップするとゲームが一時停止し、アップグレードを選択するとゲームが再開するように `Game.tsx` のロジックを更新しました。

## 9. マップ境界を考慮した敵の出現ロジック

- **出現ロジックの修正**:
  - `utils/spawner.ts` の `generateSpawnPoint` 関数を修正し、敵が必ずマップの境界内に生成されるようにしました。
  - プレイヤーがマップの端にいる場合でも、敵がマップ外に生成されないように、複数回のリトライとフォールバック戦略を導入しました。
- **テストの追加**:
  - `utils/spawner.test.ts` に、生成された敵がマップ内にいることを確認するテストケースを追加しました。

## 現在の状態

- ゲームの基本機能に加え、レベルアップ時のアップグレード機能が実装されました。
- プレイヤーは移動、攻撃、レベルアップ、そしてアップグレードによる自己強化が可能です。
- 敵はプレイヤーを追跡し、プレイヤーは敵を倒して経験値を得ることができます。
- プレイヤーのHPが0になるとゲームオーバーとなり、リスタートが可能です。
- マップの境界が設定され、プレイヤーと敵はマップ内に留まるようになりました。

## 次のステップ

- **機能改善とリファクタリング**
  - 敵や武器の種類の追加
  - コードの整理とパフォーマンスチューニング